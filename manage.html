<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>
<link rel="stylesheet" href="styles.css">
<style>
  body {
    font-family: 'Plus Jakarta Sans', sans-serif;
    background-color: #21275B;
    color: #fff;
    margin: 0;
    padding: 0;
  }
  .container {
    max-width: 800px;
    margin: 20px auto;
    padding: 20px;
    background-color: #21275B;
    border: 1px solid #ddd;
    border-radius: 10px;
  }
  h1 {
    text-align: center;
    color: #fff;
    margin-bottom: 20px;
  }
  .btn {
    display: block;
    width: 100%;
    background-color: #374993;
    color: white;
    border: none;
    padding: 10px 20px;
    cursor: pointer;
    border-radius: 5px;
    transition: background-color 0.3s;
    margin-top: 10px;
  }
  .btn:hover {
    background-color: #45a049;
  }
  input[type="text"], input[type="number"], input[type="date"], select {
    width: 100%;
    padding: 10px;
    margin: 10px 0;
    display: inline-block;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  th, td {
    padding: 12px;
    border: 1px solid #ddd;
    text-align: left;
  }
  th {
    background-color: #374993;
    color: white;
  }
  .action-buttons {
    display: flex;
    gap: 10px;
  }
  .action-buttons button {
    padding: 5px 10px;
    border-radius: 3px;
    border: none;
    cursor: pointer;
  }
  .action-buttons .edit-btn {
    background-color: #007BFF;
    color: white;
  }
  .action-buttons .delete-btn {
    background-color: #f44336;
    color: white;
  }
  .search-box {
    margin: 20px 0;
  }
  .search-box input {
    width: calc(100% - 20px);
    padding: 10px;
    margin: 10px;
    display: inline-block;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box;
  }
  .total-users {
    text-align: right;
    margin: 10px;
  }
</style>
</head>
<body>
<div class="container">
  <h1>User Management</h1>

  <!-- Admin login form -->
  <form id="adminLoginForm">
    <input type="text" id="adminKey" placeholder="Enter Admin Key">
    <button type="submit" class="btn">Login</button>
  </form>

  <!-- Form to add a new user -->
  <form id="addUserForm" class="user-form" style="display: none;">
    <input type="text" id="username" placeholder="Username" class="user-input">
    <input type="text" id="deviceUUID" placeholder="Device UUID" class="user-input">
    <select id="plan" class="user-input">
      <option value="free">Free Plan</option>
      <option value="silver">Silver Plan</option>
      <option value="gold">Gold Plan</option>
      <option value="diamond">Diamond Plan</option>
    </select>
    <button type="submit" class="btn">Add User</button>
  </form>

  <!-- Form to edit a user -->
  <form id="editUserForm" class="user-form" style="display: none;">
    <input type="text" id="editUsername" placeholder="Username" class="user-input">
    <input type="text" id="editDeviceUUID" placeholder="Device UUID" class="user-input">
    <select id="editPlan" class="user-input">
      <option value="free">Free Plan</option>
      <option value="silver">Silver Plan</option>
      <option value="gold">Gold Plan</option>
      <option value="diamond">Diamond Plan</option>
    </select>
    <input type="number" id="editCredits" placeholder="Credits" class="user-input">
    <input type="date" id="editExpiry" class="user-input">
    <button type="submit" class="btn">Update User</button>
  </form>

  <!-- Button to reset all user credits -->
  <button id="resetCreditsBtn" class="btn reset-btn" style="display: none;">Reset All User Credits</button>

  <!-- Search box -->
  <div class="search-box" style="display: none;">
    <input type="text" id="searchBox" placeholder="Search users...">
  </div>

<button id="deleteUsersBtn" class="btn delete-btn" style="display: none;">Delete Users</button>

  <!-- Total users counter -->
  <div class="total-users" style="display: none;">
    Total Users: <span id="totalUsers">0</span>
  </div>

  <!-- Table to display existing users -->
  <div class="user-table" style="display: none;">
    <table id="userTable">
      <thead>
        <tr>
          <th>Username</th>
          <th>Device UUID</th>
          <th>UID</th>
          <th>Access Key</th>
          <th>Credits</th>
          <th>Expiry Date</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="userTableBody">
        <!-- User data will be populated here -->
      </tbody>
    </table>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
<script>

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyB3T149047eNkEN7L9WAdclSkA4owR93h4",
    authDomain: "freeorcle.firebaseapp.com",
    projectId: "freeorcle",
    storageBucket: "freeorcle.appspot.com",
    messagingSenderId: "13265591895",
    appId: "1:13265591895:web:76f24a19f458f6ef198d12",
    measurementId: "G-YNWD1GR7SV"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const adminLoginForm = document.getElementById('adminLoginForm');
const addUserForm = document.getElementById('addUserForm');
const editUserForm = document.getElementById('editUserForm');
const userTable = document.querySelector('.user-table');
const resetCreditsBtn = document.getElementById('resetCreditsBtn');
const searchBox = document.getElementById('searchBox');
const totalUsersElement = document.getElementById('totalUsers');
const searchBoxContainer = document.querySelector('.search-box');
const totalUsersContainer = document.querySelector('.total-users');

// Check if the user is already logged in
const isLoggedIn = localStorage.getItem('adminLoggedIn');

if (isLoggedIn === 'true') {
  adminLoginForm.style.display = 'none';
  addUserForm.style.display = 'block';
  userTable.style.display = 'block';
  resetCreditsBtn.style.display = 'block';
  searchBoxContainer.style.display = 'block';
  totalUsersContainer.style.display = 'block';
  displayUsers();
}

// Admin login event listener
adminLoginForm.addEventListener('submit', (e) => {
  e.preventDefault();
  const adminKey = document.getElementById('adminKey').value.trim();

  // Check if admin key is correct
  if (adminKey === 'HNM3322k') {
    // Store login status in localStorage
    localStorage.setItem('adminLoggedIn', 'true');

    adminLoginForm.style.display = 'none';
    addUserForm.style.display = 'block';
    userTable.style.display = 'block';
    resetCreditsBtn.style.display = 'block';
    searchBoxContainer.style.display = 'block';
    totalUsersContainer.style.display = 'block';
    displayUsers();
  } else {
    alert('Invalid admin key');
  }
});

// Function to add a new user
addUserForm.addEventListener('submit', (e) => {
  e.preventDefault();
  const username = document.getElementById('username').value;
  const deviceUUID = document.getElementById('deviceUUID').value;
  const plan = document.getElementById('plan').value;
  const accessKey = generateAccessKey();
  let credits, validity;

  switch (plan) {
    case 'free':
      credits = 2;
      validity = 2; // days
      break;
    case 'silver':
      credits = 5;
      validity = 5; // days
      break;
    case 'gold':
      credits = 15;
      validity = 11; // days
      break;
    case 'diamond':
      credits = 50;
      validity = 29; // days
      break;
    default:
      credits = 5;
      validity = 5;
  }

  const expiryDate = new Date();
  expiryDate.setDate(expiryDate.getDate() + validity);

  db.collection('access_keys').doc(accessKey).set({
    username: username,
    deviceUUID: deviceUUID,
    plan: plan,
    credits: credits,
    expiry: expiryDate.toISOString()
  }).then(() => {
    console.log('User added successfully');
    displayUsers(); // Refresh user table
  }).catch(error => {
    console.error('Error adding user: ', error);
  });
});

// Function to generate access key (UUID)
function generateAccessKey() {
  // Generate a UUID (Universally Unique Identifier)
  return uuid.v4();
}

// Function to delete a user
function deleteUser(userId) {
  db.collection('access_keys').doc(userId).delete().then(() => {
    console.log('User deleted successfully');
    displayUsers(); // Refresh user table
  }).catch(error => {
    console.error('Error deleting user: ', error);
  });
}

// Function to edit a user
function editUser(userId) {
  const docRef = db.collection('access_keys').doc(userId);
  docRef.get().then((doc) => {
    if (doc.exists) {
      const userData = doc.data();
      document.getElementById('editUsername').value = userData.username;
      document.getElementById('editDeviceUUID').value = userData.deviceUUID;
      document.getElementById('editPlan').value = userData.plan;
      document.getElementById('editCredits').value = userData.credits;
      document.getElementById('editExpiry').value = new Date(userData.expiry).toISOString().split('T')[0];
      editUserForm.dataset.userId = userId; // Store user ID in form's dataset
      addUserForm.style.display = 'none';
      editUserForm.style.display = 'block';
    } else {
      console.error('No such document!');
    }
  }).catch((error) => {
    console.error('Error getting document:', error);
  });
}

// Event listener for the edit form submission
editUserForm.addEventListener('submit', (e) => {
  e.preventDefault();
  const userId = editUserForm.dataset.userId;
  const username = document.getElementById('editUsername').value;
  const deviceUUID = document.getElementById('editDeviceUUID').value;
  const plan = document.getElementById('editPlan').value;
  const credits = document.getElementById('editCredits').value;
  const expiryDate = document.getElementById('editExpiry').value;

  db.collection('access_keys').doc(userId).update({
    username: username,
    deviceUUID: deviceUUID,
    plan: plan,
    credits: credits,
    expiry: new Date(expiryDate).toISOString()
  }).then(() => {
    console.log('User updated successfully');
    editUserForm.style.display = 'none';
    addUserForm.style.display = 'block';
    displayUsers(); // Refresh user table
  }).catch((error) => {
    console.error('Error updating document: ', error);
  });
});

// Function to display users
function displayUsers() {
  const userTableBody = document.getElementById('userTableBody');
  userTableBody.innerHTML = ''; // Clear existing data

  db.collection('access_keys').get().then(querySnapshot => {
    let totalUsers = 0;
    querySnapshot.forEach(doc => {
      totalUsers++;
      const userData = doc.data();
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${userData.username}</td>
        <td>${userData.deviceUUID}</td>
        <td>${userData.uid || ''}</td>
        <td>${doc.id}</td>
        <td>${userData.credits}</td>
        <td>${new Date(userData.expiry).toLocaleDateString()}</td>
        <td class="action-buttons">
          <button class="edit-btn" onclick="editUser('${doc.id}')">Edit</button>
          <button class="delete-btn" onclick="deleteUser('${doc.id}')">Delete</button>
        </td>
      `;
      userTableBody.appendChild(row);
    });
    totalUsersElement.innerText = totalUsers;
  }).catch(error => {
    console.error('Error displaying users: ', error);
  });
}

// Function to add credits according to their plans
resetCreditsBtn.addEventListener('click', () => {
  db.collection('access_keys').get().then(querySnapshot => {
    const batch = db.batch();
    querySnapshot.forEach(doc => {
      const userData = doc.data();
      let additionalCredits = 0;

      switch (userData.plan) {
        case 'free':
          additionalCredits = 2;
          break;
        case 'silver':
          additionalCredits = 5;
          break;
        case 'gold':
          additionalCredits = 15;
          break;
        case 'diamond':
          additionalCredits = 50;
          break;
        default:
          additionalCredits = 2; // Assuming Free plan has 2 additional credits
          break;
      }

      const userRef = db.collection('access_keys').doc(doc.id);
      batch.update(userRef, { credits: userData.credits + additionalCredits });
    });
    return batch.commit();
  }).then(() => {
    console.log('User credits added according to their plans');
    displayUsers(); // Refresh user table
  }).catch(error => {
    console.error('Error adding user credits: ', error);
  });
});

// Search functionality
searchBox.addEventListener('input', () => {
  const searchTerm = searchBox.value.toLowerCase();
  const userTableBody = document.getElementById('userTableBody');
  const rows = userTableBody.getElementsByTagName('tr');

  Array.from(rows).forEach(row => {
    const cells = row.getElementsByTagName('td');
    const username = cells[0].innerText.toLowerCase();
    const deviceUUID = cells[1].innerText.toLowerCase();
    const accessKey = cells[3].innerText.toLowerCase();

    if (username.includes(searchTerm) || deviceUUID.includes(searchTerm) || accessKey.includes(searchTerm)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
});


// Function to delete users with null device UUID or 0 credits
function deleteUsersWithNullUUIDOrZeroCredits() {
  db.collection('access_keys').where('deviceUUID', '==', null).get()
    .then(snapshot => {
      const batch = db.batch();
      snapshot.forEach(doc => {
        batch.delete(doc.ref);
      });
      return batch.commit();
    })
    .then(() => {
      console.log('Users with null device UUID deleted');
      return db.collection('access_keys').where('credits', '==', 0).get();
    })
    .then(snapshot => {
      const batch = db.batch();
      snapshot.forEach(doc => {
        batch.delete(doc.ref);
      });
      return batch.commit();
    })
    .then(() => {
      console.log('Users with 0 credits deleted');
      displayUsers(); // Refresh user table
    })
    .catch(error => {
      console.error('Error deleting users:', error);
    });
}

// Event listener for the delete users button
document.getElementById('deleteUsersBtn').addEventListener('click', () => {
  deleteUsersWithNullUUIDOrZeroCredits();
});


// Initialize the admin panel
function init() {
  if (localStorage.getItem('adminLoggedIn') === 'true') {
    adminLoginForm.style.display = 'none';
    addUserForm.style.display = 'block';
    userTable.style.display = 'block';
    resetCreditsBtn.style.display = 'block';
    deleteUsersBtn.style.display = 'block'; // Display the delete users button
    searchBoxContainer.style.display = 'block';
    totalUsersContainer.style.display = 'block';
    displayUsers();
  }
}

// Call init function on page load
window.onload = init;

</script> 
</body>
</html>
